---
import fs from 'node:fs';
import path from 'node:path';
import Layout from '../layouts/Base.astro';

const repoRoot = path.resolve(process.cwd(), '..', '..');
const eventsRoot = path.join(repoRoot, 'memory', 'episodic');
const events: { title: string; when: string; rel: string }[] = [];

function parseFrontmatter(txt: string) {
  const m = txt.match(/^---\n([\s\S]*?)\n---/);
  if (!m) return {} as any;
  const fm = m[1];
  const get = (k: string) => {
    const r = new RegExp(`^${k}:\\s*(.+)$`, 'm');
    const mm = fm.match(r); return mm ? mm[1].trim() : '';
  };
  return { title: get('title'), when: get('when') };
}

if (fs.existsSync(eventsRoot)) {
  const walk = (dir: string) => {
    for (const e of fs.readdirSync(dir, { withFileTypes: true })) {
      const p = path.join(dir, e.name);
      if (e.isDirectory()) walk(p);
      else if (e.isFile() && p.endsWith('.md')) {
        const txt = fs.readFileSync(p, 'utf8');
        const { title, when } = parseFrontmatter(txt);
        events.push({ title: title || path.basename(p), when: when || '', rel: path.relative(repoRoot, p) });
      }
    }
  };
  walk(eventsRoot);
}
---
<Layout title="Events">
  <h1 class="text-2xl font-semibold mb-4">Events</h1>
  <p class="muted mb-6">Total: {events.length}</p>
  <ul class="grid gap-3">
    {events.map(e => (
      <li class="card p-4 flex items-center justify-between">
        <div>
          <div class="text-sm uppercase tracking-wide muted">{e.when}</div>
          <div class="text-lg">{e.title}</div>
        </div>
        <code class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-800">{e.rel}</code>
      </li>
    ))}
  </ul>
</Layout>
