import{d as f,w as d}from"./index.enr_Xien.js";import{A as m}from"./api-config.BAZ_dc_Y.js";import{isNodejsMobileAvailable as y,isNodeReady as b}from"./node-bridge.CdnDofoo.js";const i={excellent:100,good:250,fair:500,poor:1e3},h={checkIntervalMs:3e4,timeoutMs:5e3,maxConsecutiveFailures:3},a=d({connected:!1,latencyMs:0,quality:"offline",lastCheck:new Date,consecutiveFailures:0}),w=d({...h});let c=null;function k(e,s){return e<i.excellent?"excellent":e<i.good?"good":e<i.fair?"fair":e<i.poor?"poor":"offline"}async function l(){let e;const s=Date.now();if(m()){const t=y(),o=b();if(t&&o)e={connected:!0,latencyMs:0,quality:"excellent",lastCheck:new Date,consecutiveFailures:0,serverVersion:"local"};else{let n=0;a.subscribe(r=>{n=r.consecutiveFailures})(),e={connected:!1,latencyMs:0,quality:"offline",lastCheck:new Date,consecutiveFailures:n+1,error:t?"Local runtime starting...":"nodejs-mobile not available"}}return a.set(e),e}try{const t=await fetch("/api/boot",{method:"GET",signal:AbortSignal.timeout(5e3)}),o=Date.now()-s;if(t.ok||t.status===401||t.status===403){let n;if(t.ok)try{n=(await t.json()).version}catch{}e={connected:!0,latencyMs:o,quality:k(o,!0),lastCheck:new Date,consecutiveFailures:0,serverVersion:n}}else{let n=0;a.subscribe(r=>{n=r.consecutiveFailures})(),e={connected:!1,latencyMs:o,quality:"offline",lastCheck:new Date,consecutiveFailures:n+1,error:`Server returned ${t.status}`}}}catch(t){let o=0;a.subscribe(n=>{o=n.consecutiveFailures})(),e={connected:!1,latencyMs:Date.now()-s,quality:"offline",lastCheck:new Date,consecutiveFailures:o+1,error:t instanceof Error?t.message:"Health check failed"}}return a.set(e),e}function u(e){v();let s=h;w.subscribe(t=>{s=t})(),l(),c=setInterval(()=>{l()},s.checkIntervalMs),console.log("[server-health] Monitor started with interval:",s.checkIntervalMs,"ms")}function v(){c&&(clearInterval(c),c=null,console.log("[server-health] Monitor stopped"))}async function C(){return l()}const D=f(a,e=>e.connected);f(a,e=>e.quality);typeof window<"u"&&(setTimeout(()=>{u()},1e3),document.addEventListener("visibilitychange",()=>{document.hidden?v():u()}));export{C as f,a as h,D as i};
