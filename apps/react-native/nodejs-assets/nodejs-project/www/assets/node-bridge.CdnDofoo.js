import{A as g,_ as P}from"./api-config.BAZ_dc_Y.js";function C(){return typeof window>"u"?!1:window.Capacitor?.isNativePlatform?.()===!0}function L(){if(typeof window>"u")return null;const e=window.Capacitor;if(!e?.isNativePlatform?.())return null;const t=e.Plugins;if(t?.NodejsMobile)return t.NodejsMobile;try{const{registerPlugin:r}=e;if(r)return r("NodejsMobile")}catch(r){console.error("[nodejs-mobile] Failed to register plugin:",r)}return null}let s=null;function c(){if(s)return s;const e=L();return e?(s=e,s):(s={async start(t){console.log("[nodejs-mobile] Not available on web platform")},async send(t){console.log("[nodejs-mobile] Not available on web platform")},async isReady(){return{ready:!1,initialized:!1,engineStarted:!1}},async addListener(t,r){return{remove:async()=>{}}},async removeAllListeners(){}},s)}const y={start(e){return c().start(e)},send(e){return c().send(e)},isReady(){return c().isReady()},addListener(e,t){return c().addListener(e,t)},removeAllListeners(){return c().removeAllListeners()}};function H(){return C()}let h=null,u=!1,f=null;async function j(){if(!u){if(f){await f;return}f=(async()=>{if(typeof window<"u"&&g())try{h=(await P(()=>import("./index.CXATIzgh.js"),[])).CapacitorHttp,u=!0}catch{console.warn("[node-bridge] Failed to load CapacitorHttp"),u=!0}else u=!0})(),await f}}function R(){return h}const M=4322,T=`http://127.0.0.1:${M}`;let n=!1,a=!1,l=!1;function m(){return H()}function I(){return n&&l}async function _(){if(!g()||!m()){console.log("[node-bridge] Not on mobile or nodejs not available");return}if(!(n||a)){a=!0;try{const e=await y.isReady();if(console.log("[node-bridge] Initial status check:",e),e.engineStarted){console.log("[node-bridge] Node.js engine already running"),n=!0,await w(),a=!1;return}console.log("[node-bridge] Starting Node.js runtime..."),await y.start({script:"main.js",redirectOutputToLogcat:!0}),console.log("[node-bridge] Node.js start called - waiting for HTTP server"),await new Promise((t,r)=>{const o=setTimeout(()=>{n||(a=!1,r(new Error("Node.js startup timeout")))},15e3),p=setInterval(async()=>{try{(await y.isReady()).engineStarted&&(n=!0,clearInterval(p),clearTimeout(o),console.log("[node-bridge] Node.js runtime ready"),t())}catch(i){console.error("[node-bridge] isReady check failed:",i)}},500)}),await w(),a=!1}catch(e){if((e instanceof Error?e.message:String(e)).includes("already started")){console.log("[node-bridge] Engine was already started"),n=!0,await w(),a=!1;return}throw console.error("[node-bridge] Failed to start Node.js:",e),a=!1,e}}}async function w(e=1e4){const t=Date.now();await j();const r=R();if(!r)return console.error("[node-bridge] CapacitorHttp not available"),!1;for(;Date.now()-t<e;){try{const o=await r.get({url:`${T}/api/status`});if(o.status>=200&&o.status<300)return l=!0,console.log("[node-bridge] HTTP server ready"),!0}catch{}await new Promise(o=>setTimeout(o,200))}return console.error("[node-bridge] HTTP server failed to start"),!1}async function E(e=1e4){if(n&&l)return!0;if(!a&&!n){console.log("[node-bridge] Runtime not started, starting now...");try{await _()}catch(r){return console.error("[node-bridge] Failed to start runtime:",r),!1}}const t=Date.now();for(;Date.now()-t<e;){if(n&&l)return!0;await new Promise(r=>setTimeout(r,100))}return n&&l}function b(e,t){return console.warn(`[node-bridge] Unhandled endpoint ${e}: ${t}`),new Response(JSON.stringify({success:!1,error:t,offline:!0,localFirst:!0}),{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"application/json","X-Offline-Response":"true"}})}function O(){try{const e=localStorage.getItem("mh_session");if(e)return JSON.parse(e).sessionId||null}catch{}return null}async function $(e,t){const r=`${T}${e}`;await j();const o=R();if(!o)throw new Error("CapacitorHttp not available");const p=(t?.method||"GET").toUpperCase();let i;if(t?.body)try{i=typeof t.body=="string"?JSON.parse(t.body):t.body}catch{i={_raw:String(t.body)}}const N={"Content-Type":"application/json",...t?.headers||{}},v=O();v&&(N.Cookie=`mh_session=${v}`);const d=await o.request({url:r,method:p,data:i,headers:N}),S=typeof d.data=="string"?d.data:JSON.stringify(d.data);return new Response(S,{status:d.status,headers:new Headers(d.headers)})}async function A(e,t){if(g()){if(!m())return b(e,"nodejs-mobile not available");if(!n||!l){if(console.log(`[node-bridge] Waiting for runtime before ${e}...`),!await E(1e4))return b(e,"Local runtime startup timeout");console.log(`[node-bridge] Runtime ready, proceeding with ${e}`)}try{return await $(e,t)}catch(r){const o=r instanceof Error?r.message:"Local request failed";return b(e,o)}}return fetch(e,{...t,credentials:"include"})}async function B(){if(!g()){console.log("[node-bridge] Not on mobile, skipping Node.js init");return}if(!m()){console.log("[node-bridge] nodejs-mobile not available");return}try{await _(),console.log("[node-bridge] Node.js bridge initialized")}catch(e){console.error("[node-bridge] Failed to initialize:",e)}}export{B as initNodeBridge,I as isNodeReady,m as isNodejsMobileAvailable,A as nodeBridge,_ as startNodeRuntime};
