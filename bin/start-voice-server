#!/usr/bin/env bash
#
# Auto-start voice server based on active TTS provider in voice.json
# Only starts the server for the provider you're actually using
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Determine active profile (greggles is default, could read from config later)
PROFILE="greggles"
VOICE_CONFIG="$REPO_ROOT/profiles/$PROFILE/etc/voice.json"

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Check if voice config exists
if [ ! -f "$VOICE_CONFIG" ]; then
  echo -e "${YELLOW}⚠ No voice.json found, skipping voice server startup${NC}"
  exit 0
fi

# Read active TTS provider from config
PROVIDER=$(jq -r '.tts.provider // "piper"' "$VOICE_CONFIG" 2>/dev/null || echo "piper")

echo "• Active TTS provider: $PROVIDER"

# Start appropriate server based on provider
case "$PROVIDER" in
  "rvc")
    # Start RVC persistent server
    RVC_PID_FILE="$REPO_ROOT/logs/run/rvc.pid"

    # Check if already running
    if [ -f "$RVC_PID_FILE" ]; then
      PID=$(cat "$RVC_PID_FILE" 2>/dev/null || echo "")
      if [ -n "$PID" ] && kill -0 "$PID" 2>/dev/null; then
        echo "  ✓ RVC server already running (PID: $PID)"
        exit 0
      fi
    fi

    # Check if port is already in use
    if lsof -ti:9881 > /dev/null 2>&1; then
      echo "  ⚠ RVC port 9881 already in use"
      exit 0
    fi

    # Start RVC server
    echo "  Starting RVC persistent server..."

    RVC_DIR="$REPO_ROOT/external/applio-rvc"
    PYTHON_BIN="$RVC_DIR/venv/bin/python3"
    SERVER_SCRIPT="$RVC_DIR/server.py"
    MODELS_DIR="$REPO_ROOT/profiles/$PROFILE/out/voices/rvc-models"
    LOG_FILE="$REPO_ROOT/logs/run/rvc-server.log"

    # Verify RVC installation
    if [ ! -f "$PYTHON_BIN" ]; then
      echo -e "  ${RED}✗ RVC Python environment not found at $PYTHON_BIN${NC}"
      echo "    Install RVC first or switch to a different TTS provider"
      exit 1
    fi

    if [ ! -f "$SERVER_SCRIPT" ]; then
      echo -e "  ${RED}✗ RVC server script not found at $SERVER_SCRIPT${NC}"
      exit 1
    fi

    # Start server in background with proper working directory
    cd "$RVC_DIR"
    nohup "$PYTHON_BIN" "$SERVER_SCRIPT" \
      --port 9881 \
      --device cuda \
      --speaker default \
      --models-dir "$MODELS_DIR" \
      > "$LOG_FILE" 2>&1 &

    RVC_PID=$!
    echo "$RVC_PID" > "$RVC_PID_FILE"

    # Wait for server to start (RVC needs a few seconds to initialize)
    sleep 5

    # Verify it's running
    if kill -0 "$RVC_PID" 2>/dev/null && curl -s --max-time 2 http://127.0.0.1:9881/health > /dev/null 2>&1; then
      echo -e "  ${GREEN}✓ RVC server started (PID: $RVC_PID)${NC}"
      echo "    Logs: $LOG_FILE"
      echo "    Endpoint: http://127.0.0.1:9881"
    else
      echo -e "  ${RED}✗ RVC server failed to start${NC}"
      echo "    Check logs: $LOG_FILE"
      rm -f "$RVC_PID_FILE"
      exit 1
    fi
    ;;

  "gpt-sovits")
    # Use existing start-sovits script for backward compatibility
    echo "  Delegating to start-sovits..."
    "$REPO_ROOT/bin/start-sovits" 2>/dev/null || true
    ;;

  "piper")
    # Piper doesn't need a server - it's a direct binary call
    echo "  ✓ Piper doesn't require a server (direct binary)"
    ;;

  *)
    echo -e "  ${YELLOW}⚠ Unknown TTS provider: $PROVIDER${NC}"
    echo "    Supported providers: rvc, gpt-sovits, piper"
    ;;
esac
