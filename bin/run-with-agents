#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

if [ "$#" -eq 0 ]; then
  echo "Usage: run-with-agents <command> [args...]" >&2
  exit 1
fi

cleanup() {
  "$REPO_ROOT/bin/mh" agent stop --all >/dev/null 2>&1 || true
}

trap cleanup EXIT INT TERM

# Check headless mode before starting agents
RUNTIME_CONFIG="$REPO_ROOT/etc/runtime.json"
if [ -f "$RUNTIME_CONFIG" ]; then
  HEADLESS=$(grep -o '"headless"[[:space:]]*:[[:space:]]*true' "$RUNTIME_CONFIG" || echo "")
  if [ -n "$HEADLESS" ]; then
    echo "⚠️  Headless mode active - skipping agent startup"
    echo "   Tunnel and web server will run, but local agents are paused"
    # Skip agent start, but continue to start tunnel and web server
  else
    "$REPO_ROOT/bin/mh" start --restart
  fi
else
  # No runtime config yet, start normally
  "$REPO_ROOT/bin/mh" start --restart
fi

# Auto-start Cloudflare tunnel if enabled
"$REPO_ROOT/bin/start-cloudflare" 2>/dev/null || true

# Auto-start voice server based on active TTS provider
"$REPO_ROOT/bin/start-voice-server" 2>/dev/null || true

cd "$REPO_ROOT/apps/site"

echo ""
# Filter out request logs ([200], [304], etc.) but keep everything else
"$@" 2>&1 | grep --line-buffered -v '\[20[0-9]\] \|[30[0-9]\] \|[40[0-9]\] \|[50[0-9]\] ' || true
