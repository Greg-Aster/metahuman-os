#!/usr/bin/env node
/**
 * S3 Download Helper - Download trained models from RunPod S3
 *
 * Usage:
 *   ./bin/s3-download <s3-key> <local-path>
 *   ./bin/s3-download greggles/2025-11-25-101234/model ./out/downloaded-model
 *
 * Prerequisites:
 *   - S3 credentials configured in .env (RUNPOD_S3_ACCESS_KEY, etc.)
 *   - AWS CLI installed (or use Node.js implementation)
 */

import { loadS3ConfigFromEnv } from '../packages/core/src/s3-upload.js';
import { execSync } from 'node:child_process';
import fs from 'node:fs';
import path from 'node:path';

function showUsage() {
  console.log(`
S3 Download Helper - Download trained models from RunPod S3

Usage:
  ./bin/s3-download <s3-key> <local-path>

Example:
  ./bin/s3-download greggles/2025-11-25-101234/model ./out/downloaded-model

Prerequisites:
  - S3 credentials configured in .env
  - AWS CLI installed (apt install awscli or brew install awscli)

Environment Variables (in .env):
  RUNPOD_S3_ACCESS_KEY     - RunPod S3 access key
  RUNPOD_S3_SECRET_KEY     - RunPod S3 secret key
  RUNPOD_S3_ENDPOINT       - RunPod S3 endpoint (default: https://storage.runpod.io)
  RUNPOD_S3_BUCKET         - RunPod S3 bucket (default: metahuman-training)
`);
  process.exit(1);
}

async function main() {
  const args = process.argv.slice(2);

  if (args.length < 2 || args.includes('--help') || args.includes('-h')) {
    showUsage();
  }

  const [s3Key, localPath] = args;

  // Load S3 config from environment
  const s3Config = loadS3ConfigFromEnv();
  if (!s3Config) {
    console.error('âŒ S3 configuration not found in .env');
    console.error('Required environment variables:');
    console.error('  - RUNPOD_S3_ACCESS_KEY');
    console.error('  - RUNPOD_S3_SECRET_KEY');
    console.error('  - RUNPOD_S3_ENDPOINT (optional, defaults to https://storage.runpod.io)');
    console.error('  - RUNPOD_S3_BUCKET (optional, defaults to metahuman-training)');
    process.exit(1);
  }

  // Check if AWS CLI is installed
  try {
    execSync('aws --version', { stdio: 'ignore' });
  } catch {
    console.error('âŒ AWS CLI not installed');
    console.error('Install with:');
    console.error('  Ubuntu/Debian: sudo apt install awscli');
    console.error('  macOS: brew install awscli');
    console.error('  Or: https://docs.aws.amazon.com/cli/latest/userguide/getting-started-install.html');
    process.exit(1);
  }

  // Ensure local directory exists
  const localDir = path.resolve(localPath);
  if (!fs.existsSync(localDir)) {
    fs.mkdirSync(localDir, { recursive: true });
  }

  console.log(`ðŸ“¥ Downloading from S3...`);
  console.log(`  Source: s3://${s3Config.bucket}/${s3Key}`);
  console.log(`  Destination: ${localDir}`);
  console.log();

  // Build AWS CLI command
  const env = {
    ...process.env,
    AWS_ACCESS_KEY_ID: s3Config.accessKeyId,
    AWS_SECRET_ACCESS_KEY: s3Config.secretAccessKey,
    AWS_DEFAULT_REGION: s3Config.region || 'us-east-1',
  };

  const s3Url = `s3://${s3Config.bucket}/${s3Key}`;
  const cmd = `aws s3 sync ${s3Url} ${localDir} --endpoint-url ${s3Config.endpoint}`;

  try {
    execSync(cmd, { stdio: 'inherit', env });
    console.log();
    console.log('âœ… Download complete!');
    console.log(`ðŸ“ Model saved to: ${localDir}`);
  } catch (error) {
    console.error();
    console.error('âŒ Download failed');
    console.error(`Error: ${(error as Error).message}`);
    process.exit(1);
  }
}

main().catch(err => {
  console.error('Fatal error:', err);
  process.exit(1);
});
