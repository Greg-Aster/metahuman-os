#!/bin/bash
#
# MetaHuman OS PM2 Shutdown Script
#
# Stops all MetaHuman services started by start-pm2.
#
# Usage:
#   ./bin/stop-pm2
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "Stopping MetaHuman OS..."
echo

print_status() {
    echo -e "${GREEN}âœ“${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}!${NC} $1"
}

# Stop PM2 processes
if command -v pm2 &> /dev/null; then
    if pm2 list 2>/dev/null | grep -q "metahuman-web"; then
        echo "Stopping PM2 web server..."
        pm2 stop metahuman-web 2>/dev/null || true
        pm2 delete metahuman-web 2>/dev/null || true
        print_status "PM2 web server stopped"
    else
        print_warning "No PM2 processes running"
    fi
else
    print_warning "PM2 not installed"
fi

# Stop background agents
echo "Stopping agents..."
timeout 5 "$REPO_ROOT/bin/mh" agent stop --all 2>/dev/null || true
print_status "Agent stop command sent"

# Stop optional services
"$REPO_ROOT/bin/stop-terminal" 2>/dev/null || true

# Stop Big Brother terminal (port 3099)
BB_PID_FILE="$REPO_ROOT/logs/run/big-brother-terminal.pid"
if [ -f "$BB_PID_FILE" ]; then
    BB_PID=$(cat "$BB_PID_FILE" 2>/dev/null || echo "")
    if [ -n "$BB_PID" ] && kill -0 "$BB_PID" 2>/dev/null; then
        echo "Stopping Big Brother terminal..."
        kill "$BB_PID" 2>/dev/null || true
        rm -f "$BB_PID_FILE"
        print_status "Big Brother terminal stopped"
    else
        rm -f "$BB_PID_FILE"
    fi
fi
# Also try to kill by port in case PID file is missing/stale
pkill -f "ttyd.*3099" 2>/dev/null || true

# Force kill any remaining processes
echo "Cleaning up remaining processes..."
pkill -f "brain/agents" 2>/dev/null || true
pkill -f "scheduler-service" 2>/dev/null || true
pkill -f "audio-organizer" 2>/dev/null || true

# Clean up stale PID files
PID_DIR="$REPO_ROOT/logs/run"
if [ -d "$PID_DIR" ]; then
    for pidfile in "$PID_DIR"/*.pid; do
        [ -f "$pidfile" ] || continue
        pid=$(cat "$pidfile" 2>/dev/null || echo "")
        if [ -n "$pid" ]; then
            if ! kill -0 "$pid" 2>/dev/null; then
                rm -f "$pidfile"
            fi
        else
            rm -f "$pidfile"
        fi
    done
fi

# Clean up stale lock files
LOCK_DIR="$REPO_ROOT/logs/run/locks"
if [ -d "$LOCK_DIR" ]; then
    for lockfile in "$LOCK_DIR"/*.lock; do
        [ -f "$lockfile" ] || continue
        pid=$(grep -o '"pid"[[:space:]]*:[[:space:]]*[0-9]*' "$lockfile" 2>/dev/null | grep -o '[0-9]*' || echo "")
        if [ -n "$pid" ]; then
            if ! kill -0 "$pid" 2>/dev/null; then
                rm -f "$lockfile"
            fi
        else
            rm -f "$lockfile"
        fi
    done
fi

# Clean up agent registry
REGISTRY_FILE="$REPO_ROOT/logs/agents/running.json"
if [ -f "$REGISTRY_FILE" ] && command -v node >/dev/null 2>&1; then
    node -e "
const fs = require('fs');
try {
    const registry = JSON.parse(fs.readFileSync('$REGISTRY_FILE', 'utf-8'));
    const clean = {};
    for (const [name, info] of Object.entries(registry)) {
        try { process.kill(info.pid, 0); clean[name] = info; } catch (e) {}
    }
    fs.writeFileSync('$REGISTRY_FILE', JSON.stringify(clean, null, 2));
} catch (e) {}
" 2>/dev/null || true
fi

print_status "Cleanup complete"
echo
echo "MetaHuman OS stopped"
