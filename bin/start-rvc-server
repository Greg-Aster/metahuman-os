#!/bin/bash
# Start RVC persistent server for MetaHuman OS
# This keeps RVC models loaded in GPU for 10-20x faster voice synthesis

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
RVC_DIR="$ROOT_DIR/external/applio-rvc"
PYTHON="$RVC_DIR/venv/bin/python3"
SERVER_SCRIPT="$RVC_DIR/server.py"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Default config
PORT=9881
DEVICE="cuda"
SPEAKER="default"
MODELS_DIR="$ROOT_DIR/profiles/greggles/out/voices/rvc-models"

# Check if server is already running
if lsof -ti:$PORT > /dev/null 2>&1; then
    echo -e "${YELLOW}⚠ RVC server already running on port $PORT${NC}"
    echo "Use 'pkill -f rvc/server.py' to stop it first"
    exit 1
fi

# Check if Python venv exists
if [ ! -f "$PYTHON" ]; then
    echo -e "${RED}✗ RVC Python environment not found${NC}"
    echo "Expected: $PYTHON"
    exit 1
fi

# Check if FastAPI is installed
if ! "$PYTHON" -c "import fastapi" 2>/dev/null; then
    echo -e "${YELLOW}⚠ FastAPI not installed, installing dependencies...${NC}"
    "$RVC_DIR/venv/bin/pip" install fastapi uvicorn pydantic
fi

echo -e "${GREEN}=== Starting RVC Persistent Server ===${NC}\n"
echo "Port: $PORT"
echo "Device: $DEVICE"
echo "Models: $MODELS_DIR"
echo "Speaker: $SPEAKER"
echo ""
echo -e "${YELLOW}This will keep RVC models loaded in GPU for fast voice synthesis${NC}"
echo -e "${YELLOW}Expected performance: 500ms-2s per request (vs 5-10s cold start)${NC}"
echo ""

# Start server (must run from RVC directory for config files)
cd "$RVC_DIR"
exec "$PYTHON" "$SERVER_SCRIPT" \
    --port $PORT \
    --device $DEVICE \
    --speaker $SPEAKER \
    --models-dir "$MODELS_DIR"
